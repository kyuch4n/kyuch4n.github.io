<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="kyu's personal blog" />
  <meta name="keyword" content="kyuchan, kyuch4n, blog, fe, åšå®¢, ä¸ªäººç½‘ç«™, äº’è”ç½‘, å‰ç«¯" />
  <!-- ç™¾åº¦ç«™é•¿å·¥å…·éªŒè¯ -->
  <meta name="baidu-site-verification" content="code-2bes95grWe" />
  <!-- Google Search å·¥å…·éªŒè¯ -->
  <meta name="google-site-verification" content="LjMTRPYT7DFSO2MiIWUn59U50dUNsk7dcvYew79cfac" />
  <title>
    
      å…³äº beforeunload/unload çš„äºŒä¸‰äº‹ - KYU
    
  </title>

  <link rel="shortcut icon" href="/assets/favicon.ico" />
  <link rel="canonical" href="https://kyuch4n.github.io/2020/09/19/sth-about-beforeunload/" />
  <!-- Bootstrap Core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" />
  <!-- Pygments Github CSS -->
  <link rel="stylesheet" href="/css/syntax.css" />
  <!-- Custom Fonts -->
  <link href="https://cdn.staticfile.org/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
  <!-- Custom CSS -->
  <!-- WARNING: Must after bootstrap.css to cover style -->
  <link rel="stylesheet" href="/css/framework.css" />
  <!-- Preload Img -->
  <link rel="preload" href="/assets/home.jpg" as="image">
  <link rel="preload" href="/assets/post.jpg" as="image">
  <link rel="preload" href="/assets/tags.jpg" as="image">
  <link rel="preload" href="/assets/404.jpg" as="image">


  <!-- ç™¾åº¦ç»Ÿè®¡æ‰“ç‚¹ -->
  <!-- https://tongji.baidu.com/web/10000277564/homepage/index -->
  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement('script');
      hm.src = 'https://hm.baidu.com/hm.js?875ba0bb95ae7eb90248d044ccf946de';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>
  <!-- Prefetch By Google QuickLink -->
  <script src="https://unpkg.com/quicklink"></script>
  <script>
    window.addEventListener('load', () => {
      quicklink.listen();
    });
  </script>
  <!-- å½©è›‹ -->
  <script>
    console.log('æŒ–è—•ï¼Œä½ å‘ç°äº†å½©è›‹ï¼ï¼ï¼ï¼ï¼');
    console.log(String.raw`
          _____                _____                    _____          
         /\    \              |\    \                  /\    \         
        /::\____\             |:\____\                /::\____\        
       /:::/    /             |::|   |               /:::/    /        
      /:::/    /              |::|   |              /:::/    /         
     /:::/    /               |::|   |             /:::/    /          
    /:::/____/                |::|   |            /:::/    /           
   /::::\    \                |::|   |           /:::/    /            
  /::::::\____\________       |::|___|______    /:::/    /      _____  
 /:::/\:::::::::::\    \      /::::::::\    \  /:::/____/      /\    \ 
/:::/  |:::::::::::\____\    /::::::::::\____\|:::|    /      /::\____\
\::/   |::|~~~|~~~~~        /:::/~~~~/~~      |:::|____\     /:::/    /
 \/____|::|   |            /:::/    /          \:::\    \   /:::/    / 
       |::|   |           /:::/    /            \:::\    \ /:::/    /  
       |::|   |          /:::/    /              \:::\    /:::/    /   
       |::|   |          \::/    /                \:::\__/:::/    /    
       |::|   |           \/____/                  \::::::::/    /     
       |::|   |                                     \::::::/    /      
       \::|   |                                      \::::/    /       
        \:|   |                                       \::/____/        
         \|___|                                        ~~              
    `);
  </script>
</head>

  <body ontouchstart="">
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">BLOG</a>
    </div>
    <div id="blog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/lab/">LAB</a>
          </li>
          
          
          
          
          
          
          <li>
            <a href="/tags/">TAGS</a>
          </li>
          
          
          
          
        </ul>
      </div>
    </div>
  </div>
</nav>

<script>
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#blog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic);
  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      $navbar.className = ' ';
      setTimeout(function() {
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = '0px';
        }
      }, 400);
    } else {
      $collapse.style.height = 'auto';
      $navbar.className += ' in';
    }
  }
</script>
 <style type="text/css">
  header.intro-header {
    background-image: url('/assets/post.jpg');
  }
</style>
<header class="intro-header">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <div class="tags">
            
            <a
              class="tag"
              href="/tags/#beforeunload"
              title="beforeunload"
              >beforeunload</a
            >
            
          </div>
          <h1>å…³äº beforeunload/unload çš„äºŒä¸‰äº‹</h1>
          <h2 class="subheading"></h2>
          <span class="meta">
            Posted by
            
              kyuchan
            
            on September 19, 2020
          </span>
        </div>
      </div>
    </div>
  </div>
</header>
<article>
  <div class="container">
    <div class="row">
      <div
        class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container"
      >
        <p>åœ¨å¼€å‘ä¸­æˆ‘ä»¬ä¹Ÿè®¸ä¼šé‡åˆ°è¿™æ ·çš„éœ€æ±‚ï¼šå³åœ¨ç”¨æˆ·ç¦»å¼€å½“å‰é¡µé¢çš„æ—¶å€™å‘é€è¯·æ±‚æˆ–è€…æ‰“ç‚¹ã€‚è‡ªç„¶æˆ‘ä»¬éœ€è¦å¯¹é¡µé¢çš„ beforeunload/unload äº‹ä»¶å»åšä¸€äº›äº‹ä»¶ç›‘å¬ã€‚</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">log</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">();</span>
<span class="p">}</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">unload</span><span class="dl">"</span><span class="p">,</span> <span class="nx">log</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</code></pre></div></div>

<p>äº‹å®ä¸Šï¼Œç”±äºé¡µé¢å·²ç»è¢«ç”¨æˆ·å…³é—­äº†ï¼Œä½ çš„è¯·æ±‚å¯èƒ½å¹¶æ²¡æœ‰æˆåŠŸå‘é€ï¼ˆCanceledï¼‰ã€‚</p>

<p>å¦‚æœå¯¹äºæµè§ˆå™¨çš„å…¼å®¹æ€§æ²¡æœ‰ä»€ä¹ˆè¦æ±‚çš„è¯ï¼Œä¸å¦¨å¯ä»¥å°è¯•ä¸€ä¸‹ <code class="language-plaintext highlighter-rouge">navigator.sendBeacon</code> è¿™ä¸ª <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/sendBeacon">API</a>ã€‚</p>

<blockquote>
  <p>å¤‡æ³¨ï¼šåœ¨ unload æˆ–è€… beforeunload äº‹ä»¶å¤„ç†å™¨ä¸­å‘èµ·ä¸€ä¸ªåŒæ­¥ XMLHttpRequest æ¥å‘é€æ•°æ®å·²ç»ä¸è¢« Chrome æ”¯æŒï¼ˆåŒæ­¥çš„ xhr è¯·æ±‚ä¼šé˜»å¡é¡µé¢å…³é—­ï¼Œå¸¦æ¥ä¸å¥½çš„ç”¨æˆ·ä½“éªŒï¼‰ã€‚</p>
</blockquote>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">log</span><span class="p">()</span> <span class="p">{</span>
  <span class="nb">navigator</span><span class="p">.</span><span class="nx">sendBeacon</span><span class="p">(</span><span class="dl">"</span><span class="s2">/log</span><span class="dl">"</span><span class="p">,</span> <span class="nx">analyticsData</span><span class="p">);</span>
<span class="p">}</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">unload</span><span class="dl">"</span><span class="p">,</span> <span class="nx">log</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</code></pre></div></div>

<h1 id="confirm-dialog">Confirm dialog</h1>

<p><img width="300" src="https://kyuch4n.github.io/assets/beforeunload-dialog.png" /></p>

<p>å¦‚æœç”¨æˆ·æ­¤æ—¶æ­£åœ¨ç¼–è¾‘ä¸€äº›é‡è¦çš„ä¿¡æ¯ï¼Œå¸Œæœ›åœ¨ç”¨æˆ·ç¦»å¼€æˆ–è€…åˆ·æ–°é¡µé¢å‰è¿›è¡ŒäºŒæ¬¡ç¡®è®¤ï¼Œè¿™åˆè¯¥å¦‚ä½•å‘¢ï¼Ÿæˆ‘ä»¬è¿˜å¯ä»¥ç›‘å¬ beforeunload äº‹ä»¶å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†ã€‚</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">beforeunload</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// Cancel the event as stated by the standard.</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
  <span class="c1">// Chrome requires returnValue to be set.</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">returnValue</span> <span class="o">=</span> <span class="dl">""</span><span class="p">;</span>
<span class="p">});</span>
</code></pre></div></div>

<p>åŒæ—¶åœ¨ unload äº‹ä»¶å›è°ƒé‡Œé€šè¿‡ <code class="language-plaintext highlighter-rouge">navigator.sendBeacon</code> å‘é€è¯·æ±‚ã€‚</p>

<h1 id="further-more">Further more</h1>

<p>å¦‚æœæˆ‘ä»¬å¯¹äºæµè§ˆå™¨çš„å…¼å®¹æ€§è¿˜è¦æœ‰ä¸€å®šè¦æ±‚çš„ï¼ˆä¸èƒ½ç›´æ¥ä½¿ç”¨ sendBeacon APIï¼‰ï¼Œæˆ–è€…åœ¨å‘é€ç¦»å¼€é¡µé¢çš„è¯·æ±‚ä¹‹åæˆ‘ä»¬è¿˜éœ€è¦åšä¸€äº›è¯·æ±‚çš„å›è°ƒå¤„ç†æ€ä¹ˆåŠ ğŸ˜°ï¼Ÿ</p>

<p>æ— å¥ˆä¹‹ä¸‹æˆ‘ä»¬åªèƒ½<strong>å°†è¯·æ±‚ç½®äº beforeunload çš„äº‹ä»¶å›è°ƒä¹‹ä¸­</strong>ã€‚è¿™æ ·ï¼Œåœ¨å¼¹çª—è¿›è¡ŒäºŒæ¬¡ç¡®è®¤çš„æ—¶è¯·æ±‚ä¼šæ­£å¸¸å‘é€ï¼Œè€Œ<strong>åœ¨ unload æ‰§è¡Œå‰çš„äº‹ä»¶å¾ªç¯é‡Œé¢æ‰§è¡Œè¯·æ±‚çš„å›è°ƒ</strong>ã€‚</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">beforeunload</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// Cancel the event as stated by the standard.</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

  <span class="c1">// Ajax</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
    <span class="c1">// options</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// å›è°ƒå¤„ç†</span>
    <span class="c1">// do sth....</span>
  <span class="p">});</span>

  <span class="c1">// Chrome requires returnValue to be set.</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">returnValue</span> <span class="o">=</span> <span class="dl">""</span><span class="p">;</span>
<span class="p">});</span>
</code></pre></div></div>

<h1 id="another-question">Another question</h1>

<p>ä¸å¹¸çš„æ˜¯ï¼Œè¿™ä¹Ÿå¼•å…¥äº†æ–°çš„é—®é¢˜ï¼š<strong>ç”¨æˆ·å–æ¶ˆ/ç¡®å®šï¼Œæ²¡æœ‰å›è°ƒ APIï¼Œæ— æ³•å¾—çŸ¥</strong>ã€‚äºæ˜¯å³ä¾¿ç”¨æˆ·å–æ¶ˆäº†å…³é—­æ“ä½œã€åœç•™åœ¨å½“å‰é¡µé¢ï¼Œä»æ—§ä¼šå‘é€è¯·æ±‚ã€è§¦å‘å›è°ƒã€‚</p>

<p>å¦‚æœä½ çš„è¯·æ±‚æ˜¯å¯ä»¥è¢« <strong>revert</strong> çš„ï¼ˆA â†’ B â†’ Aï¼‰ï¼Œé‚£æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ä¸€äº›å° <strong>trick</strong> åˆ¤æ–­å‡ºç”¨æˆ·ä»ç„¶åœç•™åœ¨å½“å‰é¡µé¢ï¼Œä»è€Œé‡ç½®çŠ¶æ€ã€‚</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">beforeunload</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// Cancel the event as stated by the standard.</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

  <span class="c1">// Ajax</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
    <span class="c1">// options</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// å›è°ƒå¤„ç†</span>
    <span class="c1">// do sth...</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// revert</span>
      <span class="c1">// do sth...</span>
    <span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="c1">// Chrome requires returnValue to be set.</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">returnValue</span> <span class="o">=</span> <span class="dl">""</span><span class="p">;</span>
<span class="p">});</span>
</code></pre></div></div>

<p>å¦‚æœç”¨æˆ·åœç•™åœ¨äº†å½“å‰é¡µé¢ï¼Œåœ¨ç”¨æˆ·å–æ¶ˆäº†å¼¹çª—çš„ 1s åï¼Œæˆ‘ä»¬çš„ setTimeout é€»è¾‘å°†ä¼šè§¦å‘ï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥è¿›è¡Œè¯·æ±‚çš„ revertï¼›å¦‚æœç”¨æˆ·é€‰æ‹©äº†ç¦»å¼€ï¼Œåˆ™ä¸ä¼šè§¦å‘ setTimeout é€»è¾‘ã€‚</p>

<h1 id="at-last">At last</h1>

<p>ä¸å¹¸çš„æ˜¯ï¼Œå¦‚æœè¯·æ±‚æ— æ³•è¢« revertï¼Œè€Œç¦»å¼€æ—¶çš„éœ€æ±‚é€»è¾‘åˆæ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä¹Ÿæš‚æ—¶æ²¡æƒ³åˆ°ä»€ä¹ˆç‰¹åˆ«å¥½çš„æ–¹æ³•ã€‚ï¼ˆä¸å¦‚è€ƒè™‘æ”¹ä¸€ä¸‹äº§å“é€»è¾‘â€¦â€¦</p>
 
        <hr />
        <ul class="pager">
          
          <li class="previous">
            <a
              href="/2020/08/22/electron-todolist/"
              data-toggle="tooltip"
              data-placement="top"
              title="Electron å®ç° ToDoList"
              >&larr; Previous Post</a
            >
          </li>
           
          <li class="next">
            <a
              href="/2020/10/24/project-governance-01/"
              data-toggle="tooltip"
              data-placement="top"
              title="[WIP]ã€ŒBLOGã€é¡¹ç›®æ²»ç† (ä¸Š) - å·¥ç¨‹åŒ–"
              >Next Post &rarr;</a
            >
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</article>
 <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          
          <li>
            <a target="_top" href="mailto:qq950810@gmail.com?subject=Opinion/Advice/Suggestion About Your Blogs">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a target="_blank" href="https://weibo.com/kyuch4n">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a target="_blank" href="https://zhihu.com/people/kyuchan">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-stack-1x fa-inverse">çŸ¥</i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a target="_blank" href="https://github.com/kyuch4n">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
      </div>
    </div>
  </div>
</footer>

<script src="/js/jquery.js "></script>
<script src="/js/bootstrap.js "></script>
<script src="/js/framework.js "></script>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  // only load tagcloud.js in tag.html
  if($('#tag_cloud').length !== 0){
    async("/js/jquery.tagcloud.js",function(){
      $.fn.tagcloud.defaults = {
        color: {start: '#bbbbee', end: '#0085a1'},
      };
      $('#tag_cloud a').tagcloud();
    })
  }
</script>
<script>
  async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
      var $nav = document.querySelector("nav");
      if($nav) FastClick.attach($nav);
  })
</script>
  </body>
</html>
