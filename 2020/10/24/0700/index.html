<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="kyu's personal blog" />
  <meta name="keyword" content="kyuchan, kyuch4n, blog, fe, 博客, 个人网站, 互联网, 前端" />
<!-- 百度站长工具验证 -->
<meta name="baidu-site-verification" content="code-2bes95grWe" />
<!-- Google Search 工具验证 -->
<meta name="google-site-verification" content="LjMTRPYT7DFSO2MiIWUn59U50dUNsk7dcvYew79cfac" />
<!-- 百度统计打点 -->
<!-- https://tongji.baidu.com/web/10000277564/homepage/index -->
<script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement('script');
    hm.src = 'https://hm.baidu.com/hm.js?875ba0bb95ae7eb90248d044ccf946de';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>

  <title>
    
      「BLOG」 项目治理 (上) - 工程化 - KYU
    
  </title>

  <link rel="shortcut icon" href="/assets/favicon.ico" />
  <link rel="canonical" href="https://kyuch4n.github.io/2020/10/24/0700/" />
  <!-- Bootstrap Core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" />
  <!-- Pygments Github CSS -->
  <link rel="stylesheet" href="/css/syntax.css" />
  <!-- Custom Fonts -->
  <link href="https://cdn.staticfile.org/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
  <!-- Custom CSS -->
  <!-- WARNING: Must after bootstrap.css to cover style -->
  <link rel="stylesheet" href="/css/framework.css" />
  <script src="https://unpkg.com/react@16/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js" crossorigin></script>
<!-- widgets -->
<script src="/js/table-of-content.js"></script>
  <!-- Preload Img -->
<link rel="preload" href="/assets/home.jpg" as="image" />
<link rel="preload" href="/assets/post.jpg" as="image" />
<link rel="preload" href="/assets/tags.jpg" as="image" />
<link rel="preload" href="/assets/error.jpg" as="image" />
<!-- Prefetch By Google QuickLink -->
<script src="https://unpkg.com/quicklink"></script>
<script>
  window.addEventListener('load', () => {
    quicklink.listen();
  });
</script>
<script>
  console.log('挖藕，你发现了彩蛋！！！！！');
  console.log(String.raw`
          _____                _____                    _____          
         /\    \              |\    \                  /\    \         
        /::\____\             |:\____\                /::\____\        
       /:::/    /             |::|   |               /:::/    /        
      /:::/    /              |::|   |              /:::/    /         
     /:::/    /               |::|   |             /:::/    /          
    /:::/____/                |::|   |            /:::/    /           
   /::::\    \                |::|   |           /:::/    /            
  /::::::\____\________       |::|___|______    /:::/    /      _____  
 /:::/\:::::::::::\    \      /::::::::\    \  /:::/____/      /\    \ 
/:::/  |:::::::::::\____\    /::::::::::\____\|:::|    /      /::\____\
\::/   |::|~~~|~~~~~        /:::/~~~~/~~      |:::|____\     /:::/    /
 \/____|::|   |            /:::/    /          \:::\    \   /:::/    / 
       |::|   |           /:::/    /            \:::\    \ /:::/    /  
       |::|   |          /:::/    /              \:::\    /:::/    /   
       |::|   |          \::/    /                \:::\__/:::/    /    
       |::|   |           \/____/                  \::::::::/    /     
       |::|   |                                     \::::::/    /      
       \::|   |                                      \::::/    /       
        \:|   |                                       \::/____/        
         \|___|                                        ~~              
  `);
</script>

  <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker
        .register('/service-worker.js')
        .then(function(registration) {
          console.log(
            '[ServiceWorker] Regist successful with scope: ',
            registration.scope,
          );
        })
        .catch(function(err) {
          console.log('[ServiceWorker] Regist failed: ', err);
        });
    });
  }
</script>

</head>

  <body ontouchstart="">
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">BLOG</a>
    </div>
    <div id="blog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/lab/#/">LAB</a>
          </li>
          
          
          
          
          
          
          <li>
            <a href="/tags/">TAGS</a>
          </li>
          
          
          
          
        </ul>
      </div>
    </div>
  </div>
</nav>

<script>
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#blog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic);
  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      $navbar.className = ' ';
      setTimeout(function() {
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = '0px';
        }
      }, 400);
    } else {
      $collapse.style.height = 'auto';
      $navbar.className += ' in';
    }
  }
</script>

    <style type="text/css">
  header.intro-header {
    background-image: url('/assets/post.jpg');
  }
</style>
<header class="intro-header">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <div class="tags">
            
            <a
              class="tag"
              href="/tags/#monorepo"
              title="monorepo"
            >
              monorepo
            </a>
            
          </div>
          <h1>「BLOG」 项目治理 (上) - 工程化</h1>
          <h2 class="subheading"></h2>
          <span class="meta">
            Posted on October 24, 2020
          </span>
        </div>
      </div>
    </div>
  </div>
</header>
<article>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container">
        <h1 id="背景">背景</h1>

<p>初代的「BLOG」项目基于 <a href="http://jekyllcn.com/">Jekyll</a> 进行搭建，将 Markdown、Liquid 和 HTML &amp; CSS 构建为可发布的静态网站。</p>

<p>但相较于常用的 React、NPM 等工具，整体对于 Jekyll 的开发方式、插件体系不太熟悉（不想研究了…，所以对项目进行了一番改造。</p>

<h1 id="目标">目标</h1>

<ul>
  <li><strong>一方面</strong> 保留了原来 post 的开发编译方式（Markdown -&gt; HTML），可以通过 md 快速编写 BLOG。</li>
  <li><strong>另一方面</strong> 可以快速通过 React 开发组件或者页面，进行扩展。</li>
</ul>

<h1 id="方案">方案</h1>

<p>将原来的 Jekyll 项目命名为 <code class="language-plaintext highlighter-rouge">pangu</code>，用于创建新的 blog；基于 <a href="https://reactjs.org/docs/create-a-new-react-app.html">create-react-app</a> 新增项目 <code class="language-plaintext highlighter-rouge">shennong</code>。两个项目通过 monorepo 进行管理。</p>

<h2 id="monorepo">monorepo</h2>

<p>monorepo 的优点：</p>

<ul>
  <li>代码集中管理，方便共享和调试</li>
  <li>版本管理方便</li>
  <li>共享依赖、工程配置</li>
  <li>方便代码复用</li>
  <li>多个项目相互协作时原子提交</li>
  <li>……</li>
</ul>

<p>整体的目录结构</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
├── packages
│      ├─ pangu
│      └─ shennong
├── scripts
│      ├─ build.sh            # 项目构建脚本
│      └─ sitemap.js          # 自动生成 sitemap.xml
├── .prettierrc               # 全局 prettier 配置
├── .prettierignore
├── .gitignore                # 全局 .gitignore
├── node_modules              # 整个项目只有一个外层 node_modules
├── README.md
└── package.json
</code></pre></div></div>

<h2 id="scripts">scripts</h2>

<h3 id="global-build">global build</h3>

<p>主要流程：<code class="language-plaintext highlighter-rouge">Clear</code> → <code class="language-plaintext highlighter-rouge">Build pangu</code> → <code class="language-plaintext highlighter-rouge">Build shennong</code> → <code class="language-plaintext highlighter-rouge">Move</code> → <code class="language-plaintext highlighter-rouge">Build sitemap</code></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>

<span class="c"># Clear</span>
<span class="nb">rm</span> <span class="nt">-rf</span> build
<span class="nv">CWD</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span><span class="s2">"</span> <span class="c"># /kyuch4n.github.io</span>

<span class="c"># Pangu</span>
<span class="c"># Build</span>
<span class="nb">cd</span> <span class="nv">$CWD</span>/packages/pangu
yarn build
<span class="c"># Copy Build Files</span>
<span class="nb">cp</span> <span class="nt">-rf</span> _site <span class="nv">$CWD</span>/build

<span class="c"># Shennong</span>
<span class="c"># Build</span>
<span class="nb">cd</span> <span class="nv">$CWD</span>/packages/shennong
yarn build
<span class="c"># Copy Build Files</span>
<span class="nb">cp</span> <span class="nt">-rf</span> build <span class="nv">$CWD</span>/build/lab

<span class="c"># Regen Sitemap (Not Real Time)</span>
<span class="nb">echo</span> <span class="s1">'&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;'</span>
<span class="nb">echo</span> <span class="s1">'generate sitemap ...'</span>
node <span class="nv">$CWD</span>/scripts/sitemap.js
</code></pre></div></div>

<p>在 build.sh 中分布调用 sub-package 各自的 build 脚本。</p>

<p>构建完成后会通过 <code class="language-plaintext highlighter-rouge">cp</code> 将各个 package 的 build 文件拷贝至项目根目录的 /build 文件夹中。</p>

<h3 id="pangu-build">pangu build</h3>

<p>通过 npm init 创建了 package.json，通过 npm scripts 进行构建。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="dl">"</span><span class="s2">private</span><span class="dl">"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">@kyu/pangu</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">version</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1.0.0</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">scripts</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">watch:less</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">nodemon -e less -x </span><span class="se">\"</span><span class="s2">yarn build:less</span><span class="se">\"</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">watch:widgets</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">nodemon -e jsx -x </span><span class="se">\"</span><span class="s2">yarn build:jsx</span><span class="se">\"</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">watch:jekyll</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">jekyll serve --watch</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">start</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">run-p watch:less watch:widgets watch:jekyll</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">build:less</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">lessc less/framework.less css/framework.css</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">build:jsx</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">npx babel widgets --out-dir js --presets react-app/prod</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">build:sw</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">node scripts/gen-sw.js</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">build:jekyll</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">jekyll build</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">build</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">run-s build:sw build:less build:jsx build:jekyll</span><span class="dl">"</span>
  <span class="p">},</span>
  <span class="dl">"</span><span class="s2">dependencies</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">babel-cli</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">6</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">babel-preset-react-app</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">3</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">less</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">^3.12.2</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">nodemon</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">^2.0.6</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">npm-run-all</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">^4.1.5</span><span class="dl">"</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>并行构建 less &amp; jsx &amp; service-worker &amp; jekyll。</p>

<h2 id="react-for-pangu">react for pangu</h2>

<p>额外解决的一个小问题是如何快速在 Pangu(Jekyll) 中开发 React 小组件呢？方案是通过 CDN 加载 react 脚本。</p>

<p>具体方式可以参考 <a href="https://reactjs.org/docs/add-react-to-a-website.html">add-react-to-a-website</a>。基于该方式成功开发并引入了 table-of-contents(Post 目录)小组件。</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://unpkg.com/react@16/umd/react.production.min.js"</span> <span class="na">crossorigin</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"</span> <span class="na">crossorigin</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="c">&lt;!-- widgets --&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"/js/table-of-content.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div></div>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="dl">'</span><span class="s1">use strict</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="p">{</span> <span class="nx">createElement</span><span class="p">,</span> <span class="nx">useState</span><span class="p">,</span> <span class="nx">useEffect</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">React</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">TableOfContent</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">useState</span><span class="p">();</span>

  <span class="c1">// find all h1-h6 doms</span>
  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="p">},</span> <span class="p">[]);</span>

  <span class="c1">// listen page scroll</span>
  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">scrollHandler</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{};</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">scroll</span><span class="dl">'</span><span class="p">,</span> <span class="nx">scrollHandler</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">scroll</span><span class="dl">'</span><span class="p">,</span> <span class="nx">scrollHandler</span><span class="p">);</span>
  <span class="p">},</span> <span class="p">[]);</span>

  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>...<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;;</span>
<span class="p">};</span>

<span class="c1">// Mount</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">load</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">tableOfContentContainer</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">'</span><span class="s1">#table-of-content</span><span class="dl">'</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">tableOfContentContainer</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">TableOfContent</span><span class="p">),</span> <span class="nx">tableOfContentContainer</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<h1 id="成果">成果</h1>

<p>最终改造项目可见 <a href="https://github.com/kyuch4n/kyuch4n.github.io">Github Pro</a>。</p>

        <hr />
        <ul class="pager">
          
          <li class="previous">
            <a
              href="/2020/09/19/0000/"
              data-toggle="tooltip"
              data-placement="top"
              title="关于 beforeunload/unload 的二三事"
            >
              &larr; Previous Post
            </a>
          </li>
          
          
          <li class="next">
            <a 
              href="/2020/10/24/0800/" 
              data-toggle="tooltip" 
              data-placement="top" 
              title="「BLOG」 项目治理 (下) - 性能优化"
            >
              Next Post &rarr;
            </a>
          </li>
          
        </ul>
      </div>
      <div
        id="table-of-content"
        class="col-lg-2 col-lg-offset-0 visible-lg-block sidebar-container"
      ></div>
    </div>
  </div>
</article>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          
          <li>
            <a target="_top" href="mailto:qq950810@gmail.com?subject=Opinion/Advice/Suggestion About Your Blogs">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a target="_blank" href="https://weibo.com/kyuch4n">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a target="_blank" href="https://zhihu.com/people/kyuchan">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-stack-1x fa-inverse">知</i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a target="_blank" href="https://github.com/kyuch4n">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
      </div>
    </div>
  </div>
</footer>

<script src="/js/jquery.js "></script>
<script src="/js/bootstrap.js "></script>
<script src="/js/framework.js "></script>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  // only load tagcloud.js in tag.html
  if($('#tag_cloud').length !== 0){
    async("/js/jquery.tagcloud.js",function(){
      $.fn.tagcloud.defaults = {
        color: {start: '#bbbbee', end: '#0085a1'},
      };
      $('#tag_cloud a').tagcloud();
    })
  }
</script>
<script>
  async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
      var $nav = document.querySelector("nav");
      if($nav) FastClick.attach($nav);
  })
</script>
  </body>
</html>
